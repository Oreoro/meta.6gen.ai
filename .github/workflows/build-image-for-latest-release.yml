name: Build Latest Docker Image For Release

on:
  push:
    tags:
      - v2.*
      - v1.*
      - v0.*
      - "!v*-RC*"
  # Allows manual triggering from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v4

      - name: 🏷️ Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: oreoro/answer
          # 🚨 FIX: Dynamically captures the Git tag as the Docker tag (e.g., v1.2.3)
          # Also tags it as 'latest' if the push matches the main branch pattern (optional best practice)
          tags: |
            type=ref,event=tag
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/heads/') && github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}

      - name: ⚙️ Set up QEMU (for multi-platform builds)
        uses: docker/setup-qemu-action@v3

      - name: 🏗️ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🔑 Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: oreoro
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: 🚀 Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          file: ./Dockerfile
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # 🚨 CRITICAL FIX: Pass the custom repository path as a build argument
          build-args: |
            PACKAGE=github.com/Oreoro/meta.6gen.ai
